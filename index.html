<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistica Pro - Memoria Ativa</title>
    <style>
        :root { --azul: #1a73e8; --verde: #28a745; --vermelho: #d93025; --laranja: #f2994a; --cinza: #5f6368; }
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .card { max-width: 450px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        label { display: block; font-weight: bold; margin: 15px 0 5px; color: #444; font-size: 14px; }
        select, input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 16px; margin: 8px 0; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 15px; cursor: pointer; }
        .btn-login { background: var(--azul); }
        .btn-acao { background: var(--azul); }
        .btn-extra { background: var(--laranja); }
        .btn-alerta { background: var(--vermelho); margin-top: 15px; }
        .btn-finalizar { background: var(--verde); }
        .btn-reset { background: var(--cinza); margin-top: 25px; font-size: 12px; padding: 10px; opacity: 0.8; }
        #status { text-align: center; font-weight: bold; margin: 15px 0; color: var(--azul); min-height: 20px; }
        .header-viagem { background: #e8f0fe; padding: 10px; border-radius: 8px; font-size: 12px; color: #1967d2; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="card" id="tela-login">
    <h2 style="text-align:center; color: var(--azul);">Login Logistica</h2>
    <label>Motorista:</label>
    <select id="motorista-select">
        <option value="">-- Selecione seu nome --</option>
        <option value="Sidnei Monteiro">Sidnei Monteiro</option>
        <option value="Carlos Henrique">Carlos Henrique</option>
        <option value="Rubens Neto">Rubens Neto</option>
        <option value="Jose Carlos">Jose Carlos</option>
        <option value="Marcos Rodrigo">Marcos Rodrigo</option>
        <option value="Ramon Cristian">Ramon Cristian</option>
    </select>
    <label>Placa:</label>
    <select id="placa-select">
        <option value="">-- Selecione a placa --</option>
        <option value="PKG0266">PKG0266</option>
        <option value="SJQ4D45">SJQ4D45</option>
        <option value="SKJ2C51">SKJ2C51</option>
        <option value="SKJ9C62">SKJ9C62</option>
    </select>
    <label>Senha:</label>
    <input type="password" id="senha-input" placeholder="Senha 1234">
    <button class="btn-login" onclick="fazerLogin()">ENTRAR</button>
</div>

<div class="card hidden" id="tela-app">
    <div class="header-viagem" id="header-info"></div>
    <label>Pedido:</label>
    <input type="number" id="pedido-input">
    <label>Local:</label>
    <select id="local-select">
        <option value="CDR Camacari">CDR Camacari</option>
        <option value="Fabrica de Sergipe">Fabrica de Sergipe</option>
        <option value="Sede">Sede</option>
        <option value="Filial Vera Cruz">Filial Vera Cruz</option>
    </select>
    <div id="status">📍 Buscando GPS...</div>
    <div id="container-botoes">
        <button id="step1" class="btn-acao" onclick="registrar(1, '1-Saida da Revenda', true)">1. Saida da Revenda</button>
        <button class="btn-extra" onclick="registrar(0, 'EXTRA: Abastecimento', false)">⛽ Abastecimento</button>
        <button class="btn-extra" onclick="registrar(0, 'EXTRA: Oficina', false)">🔧 Oficina</button>
        <button id="step4" class="btn-acao hidden" onclick="registrar(4, '4-Chegada na Unidade', true)">4. Chegada Unidade</button>
        <button id="step5" class="btn-acao hidden" onclick="registrar(5, '5-Doc. na Fila', true)">5. Documento Fila</button>
        <button id="step6" class="btn-acao hidden" onclick="registrar(6, '6-Inicio Carga', true)">6. Inicio Carga</button>
        <button id="step7" class="btn-acao hidden" onclick="registrar(7, '7-Saida Carga', true)">7. Fim Carga</button>
        <button id="step8" class="btn-acao hidden" onclick="registrar(8, '8-Aguardando NF', true)">8. Aguardando NF</button>
        <button id="step9" class="btn-acao hidden" onclick="registrar(9, '9-Saida da Unidade', true)">9. Saida Unidade</button>
        <button id="step10" class="btn-finalizar hidden" onclick="registrar(10, '10-Chegada na Revenda', true)">10. Chegada Revenda</button>
        <button class="btn-alerta" onclick="relatarImprevisto()">⚠️ RELATAR IMPREVISTO</button>
        <button class="btn-reset" onclick="reiniciarCiclo()">🔄 FINALIZAR / NOVA VIAGEM</button>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwuYt7WcmL_Ed35ulFEZJsopzHfur03kKwcLDhfxzClWNx2hxgT4prczvcMrhEfCq4YxQ/exec";
    let viagem = { id: "", motorista: "", placa: "", gps: "0,0", passoAtual: 1 };

    // --- LOGICA DE MEMORIA (LocalStorage) ---
    window.onload = function() {
        const dadosSalvos = localStorage.getItem("viagem_ativa");
        if (dadosSalvos) {
            viagem = JSON.parse(dadosSalvos);
            abrirApp();
            restaurarBotoes(viagem.passoAtual);
        }
    }

    function salvarProgresso() {
        localStorage.setItem("viagem_ativa", JSON.stringify(viagem));
    }

    function fazerLogin() {
        const mot = document.getElementById('motorista-select').value;
        const pla = document.getElementById('placa-select').value;
        const sen = document.getElementById('senha-input').value;
        if(sen === "1234" && mot && pla) {
            viagem.motorista = mot; viagem.placa = pla;
            viagem.id = "V" + Math.floor(Date.now() / 1000);
            viagem.passoAtual = 1;
            salvarProgresso();
            abrirApp();
        } else { alert("Dados incorretos!"); }
    }

    function abrirApp() {
        document.getElementById('tela-login').classList.add('hidden');
        document.getElementById('tela-app').classList.remove('hidden');
        document.getElementById('header-info').innerText = viagem.motorista + " | " + viagem.placa + " | ID: " + viagem.id;
        pegarGPS();
    }

    function restaurarBotoes(passo) {
        // Esconde o passo 1
        document.getElementById('step1').classList.add('hidden');
        // Se já passou do 1, mostra o passo atual salvo
        if(passo > 1) {
            document.getElementById('step' + passo).classList.remove('hidden');
        } else {
            // Se salvou mas ainda está no 1 (ex: saiu antes de clicar), mostra o 1
            document.getElementById('step1').classList.remove('hidden');
        }
    }

    function pegarGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => { 
                viagem.gps = p.coords.latitude + "," + p.coords.longitude;
                document.getElementById('status').innerText = "📍 GPS Localizado";
            }, null, {enableHighAccuracy:true});
        }
    }

    function registrar(passo, evento, ehUnico) {
        const pedido = document.getElementById('pedido-input').value;
        if (passo === 1 && !pedido) { alert("Digite o Pedido!"); return; }
        
        pegarGPS();
        const dados = {
            dataHora: new Date().toLocaleString('pt-BR'),
            viagemID: viagem.id, motorista: viagem.motorista,
            placa: viagem.placa, evento: evento,
            local: document.getElementById('local-select').value,
            pedido: pedido, gps: viagem.gps
        };

        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });

        if (ehUnico) {
            document.getElementById('step' + (passo === 0 ? '' : passo)).classList.add('hidden');
            let proximo = 0;
            if (passo === 1) proximo = 4;
            else if (passo < 10) proximo = passo + 1;

            if (proximo > 0) {
                document.getElementById('step' + proximo).classList.remove('hidden');
                viagem.passoAtual = proximo;
                salvarProgresso();
            }

            if(passo === 10) { 
                alert("Viagem Finalizada!"); 
                reiniciarCiclo(); 
            }
        }
        document.getElementById('status').innerText = "✅ Salvo!";
    }

    function reiniciarCiclo() {
        localStorage.removeItem("viagem_ativa");
        location.reload();
    }

    function relatarImprevisto() {
        const m = prompt("Qual o imprevisto?");
        if (m) registrar(0, "IMPREVISTO: " + m, false);
    }
</script>
</body>
</html>